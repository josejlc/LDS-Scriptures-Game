<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Juegos - Juego Escrituras LDS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/game.css}" rel="stylesheet">
    <meta name="description" content="Historial completo de partidas del juego de escrituras LDS">
</head>
<body class="bg-gradient">
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-11 col-lg-10">
            <div class="card shadow-lg game-card">
                <div class="card-header bg-info text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-0">üìä Historial de Juegos</h3>
                            <p class="mb-0 opacity-75">Seguimiento completo de tu progreso</p>
                        </div>
                        <div class="col-md-4">
                            <form th:action="@{/history}" method="get" class="d-flex">
                                <input type="text"
                                       name="playerName"
                                       class="form-control form-control-sm me-2"
                                       placeholder="Buscar jugador..."
                                       th:value="${searchedPlayer}"
                                       maxlength="50">
                                <button type="submit"
                                        class="btn btn-light btn-sm"
                                        aria-label="Buscar jugador">
                                    üîç
                                </button>
                            </form>
                        </div>
                    </div>
                    <div th:if="${searchedPlayer}" class="mt-2">
                        <small class="opacity-75">
                            Mostrando resultados para: <strong th:text="${searchedPlayer}">Jugador</strong>
                            <a th:href="@{/history}" class="text-light ms-2 text-decoration-none">‚úï Limpiar</a>
                        </small>
                    </div>
                </div>
                <div class="card-body p-4">

                    <!-- Empty State -->
                    <div th:if="${#lists.isEmpty(gameHistory)}" class="empty-state text-center py-5">
                        <div class="display-4 text-muted mb-3">üìà</div>
                        <h4 class="text-muted" th:text="${searchedPlayer != null ? 'No se encontraron juegos para &quot;' + searchedPlayer + '&quot;' : 'No hay historial de juegos disponible'}">
                            No hay historial
                        </h4>
                        <p class="text-secondary mb-4">
                            <span th:if="${searchedPlayer != null}">Intenta con otro nombre de jugador o</span>
                            <span th:unless="${searchedPlayer != null}">Los juegos completados aparecer√°n aqu√≠.</span>
                            ¬°Empieza tu primera partida!
                        </p>
                        <a th:href="@{/game/start}" class="btn btn-primary">üéÆ Comenzar Juego</a>
                    </div>

                    <!-- Content with data -->
                    <div th:unless="${#lists.isEmpty(gameHistory)}">
                        <!-- Summary Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center py-3">
                                        <div class="stat-icon">üéÆ</div>
                                        <h4 class="mb-0" th:text="${historyStats.totalGames}">0</h4>
                                        <small>Total Juegos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center py-3">
                                        <div class="stat-icon">üèÜ</div>
                                        <h4 class="mb-0" th:text="${historyStats.bestScore}">0</h4>
                                        <small>Mejor Puntaje</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center py-3">
                                        <div class="stat-icon">üìä</div>
                                        <h4 class="mb-0" th:text="${#numbers.formatDecimal(historyStats.averageScore, 1, 0)}">0</h4>
                                        <small>Promedio</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center py-3">
                                        <div class="stat-icon">üë•</div>
                                        <h4 class="mb-0" th:text="${historyStats.uniquePlayers}">0</h4>
                                        <small>Jugadores</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters and Sorting -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="btn-group" role="group" aria-label="Filtros de historial">
                                    <input type="radio" class="btn-check" name="sortOptions" id="sortDate" checked>
                                    <label class="btn btn-outline-secondary" for="sortDate">üìÖ Por Fecha</label>

                                    <input type="radio" class="btn-check" name="sortOptions" id="sortScore">
                                    <label class="btn btn-outline-secondary" for="sortScore">‚≠ê Por Puntuaci√≥n</label>

                                    <input type="radio" class="btn-check" name="sortOptions" id="sortAccuracy">
                                    <label class="btn btn-outline-secondary" for="sortAccuracy">üéØ Por Precisi√≥n</label>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    Mostrando <strong th:text="${#lists.size(gameHistory)}">0</strong>
                                    resultado<span th:if="${#lists.size(gameHistory) != 1}">s</span>
                                </small>
                            </div>
                        </div>

                        <!-- History Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="historyTable">
                                <thead class="table-dark">
                                <tr>
                                    <th scope="col">üë§ Jugador</th>
                                    <th scope="col">‚≠ê Puntos</th>
                                    <th scope="col">üìä Nivel</th>
                                    <th scope="col">‚ù§Ô∏è Vidas</th>
                                    <th scope="col">üî• Mejor Racha</th>
                                    <th scope="col">‚úÖ Correctas</th>
                                    <th scope="col">‚ùå Incorrectas</th>
                                    <th scope="col">üéØ Precisi√≥n</th>
                                    <th scope="col">‚è±Ô∏è Duraci√≥n</th>
                                    <th scope="col">üìÖ Fecha</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="session : ${gameHistory}" class="history-row">
                                    <td>
                                        <strong th:text="${session.playerName}">Jugador</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6" th:text="${session.score}">0</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary" th:text="${session.levelReached}">1</span>
                                    </td>
                                    <td>
                                            <span th:class="${session.livesRemaining > 0 ? 'text-success' : 'text-danger'}"
                                                  th:text="${session.livesRemaining}">0</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark" th:text="${session.bestStreak}">0</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success" th:text="${session.correctAnswers}">0</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger" th:text="${session.incorrectAnswers}">0</span>
                                    </td>
                                    <td>
                                            <span th:class="${session.accuracyPercentage >= 80 ? 'text-success fw-bold' : (session.accuracyPercentage >= 60 ? 'text-warning fw-bold' : 'text-danger')}"
                                                  th:text="${#numbers.formatDecimal(session.accuracyPercentage, 1, 1)} + '%'">0%</span>
                                    </td>
                                    <td>
                                        <small th:if="${session.sessionEnd != null}"
                                               th:text="${#temporals.formatDuration(T(java.time.Duration).between(session.sessionStart, session.sessionEnd))}">
                                            -
                                        </small>
                                        <small th:unless="${session.sessionEnd != null}">
                                            <span class="text-warning">‚è≥ En progreso</span>
                                        </small>
                                    </td>
                                    <td>
                                        <small th:text="${#temporals.format(session.sessionStart, 'dd/MM/yyyy HH:mm')}">
                                            Fecha
                                        </small>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination (if needed) -->
                        <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4">
                            <nav aria-label="Navegaci√≥n del historial">
                                <ul class="pagination">
                                    <li class="page-item" th:class="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/history(page=${currentPage - 1}, playerName=${searchedPlayer})}">
                                            ‚Üê Anterior
                                        </a>
                                    </li>

                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                        th:class="${i == currentPage} ? 'active'">
                                        <a class="page-link" th:href="@{/history(page=${i}, playerName=${searchedPlayer})}"
                                           th:text="${i + 1}">1</a>
                                    </li>

                                    <li class="page-item" th:class="${currentPage == totalPages - 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/history(page=${currentPage + 1}, playerName=${searchedPlayer})}">
                                            Siguiente ‚Üí
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 mt-4">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <a th:href="@{/game/start}" class="btn btn-primary w-100">
                                    üéÆ Jugar Ahora
                                </a>
                            </div>
                            <div class="col-md-4 mb-2">
                                <a th:href="@{/leaderboard}" class="btn btn-warning w-100">
                                    üèÜ Ver Ranking
                                </a>
                            </div>
                            <div class="col-md-4 mb-2">
                                <a th:href="@{/}" class="btn btn-outline-secondary w-100">
                                    üè† Inicio
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/game.js}"></script>
<script>
    // Table sorting functionality
    function sortTable(columnIndex, dataType = 'string') {
        const table = document.getElementById('historyTable');
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll('tr'));

        const sortedRows = rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();

            if (dataType === 'number') {
                aVal = parseFloat(aVal.replace(/[^\d.-]/g, ''));
                bVal = parseFloat(bVal.replace(/[^\d.-]/g, ''));
                return bVal - aVal; // Descending for numbers
            } else if (dataType === 'date') {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
                return bVal - aVal; // Most recent first
            } else {
                return aVal.localeCompare(bVal);
            }
        });

        sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Sort controls
    document.getElementById('sortDate').addEventListener('change', function() {
        if (this.checked) sortTable(9, 'date');
    });

    document.getElementById('sortScore').addEventListener('change', function() {
        if (this.checked) sortTable(1, 'number');
    });

    document.getElementById('sortAccuracy').addEventListener('change', function() {
        if (this.checked) sortTable(7, 'number');
    });

    // Row hover effects
    document.querySelectorAll('.history-row').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'transform 0.2s ease';
        });

        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });

    // Auto-focus search input
    window.addEventListener('load', function() {
        const searchInput = document.querySelector('input[name="playerName"]');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
    });
</script>
</body>
</html>