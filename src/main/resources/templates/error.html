<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error - Juego Escrituras LDS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/game.css}" rel="stylesheet">
    <meta name="description" content="P√°gina de error del juego de escrituras LDS">
</head>
<body class="bg-gradient">
<div class="container-fluid min-vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg game-card">
                    <div class="card-body text-center p-5">
                        <!-- Error Icon with Animation -->
                        <div class="error-icon mb-4">
                            <div class="display-1 text-danger mb-3 error-animation">‚ö†Ô∏è</div>
                        </div>

                        <!-- Error Title -->
                        <h2 class="text-danger mb-3">¬°Oops! Algo sali√≥ mal</h2>

                        <!-- Error Message -->
                        <div class="error-message mb-4">
                            <div class="alert alert-danger" role="alert" th:if="${error}">
                                <h6 class="alert-heading">üìã Detalles del Error:</h6>
                                <p class="mb-0" th:text="${error}">Ha ocurrido un error inesperado</p>
                            </div>

                            <div class="alert alert-danger" role="alert" th:unless="${error}">
                                <h6 class="alert-heading">‚ùå Error Desconocido</h6>
                                <p class="mb-0">Ha ocurrido un error inesperado en el sistema</p>
                            </div>
                        </div>

                        <!-- Error Code (if available) -->
                        <div class="error-details mb-4" th:if="${status}">
                            <small class="text-muted">
                                C√≥digo de Error: <strong th:text="${status}">500</strong>
                            </small>
                        </div>

                        <!-- Helpful Suggestions -->
                        <div class="suggestions mb-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">üí° ¬øQu√© puedes hacer?</h6>
                                    <ul class="text-start mb-0">
                                        <li>Verifica tu conexi√≥n a internet</li>
                                        <li>Intenta refrescar la p√°gina</li>
                                        <li>Regresa al inicio y comienza de nuevo</li>
                                        <li>Si el problema persiste, intenta m√°s tarde</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <div class="d-grid gap-2 mb-3">
                                <button onclick="window.location.reload()"
                                        class="btn btn-warning btn-lg">
                                    üîÑ Refrescar P√°gina
                                </button>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-2">
                                    <a th:href="@{/}" class="btn btn-primary w-100">
                                        üè† Volver al Inicio
                                    </a>
                                </div>
                                <div class="col-6 mb-2">
                                    <a th:href="@{/game/start}" class="btn btn-success w-100">
                                        üéÆ Nuevo Juego
                                    </a>
                                </div>
                            </div>

                            <div class="row mt-2">
                                <div class="col-6">
                                    <a th:href="@{/history}" class="btn btn-outline-info w-100">
                                        üìä Mi Historial
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a th:href="@{/leaderboard}" class="btn btn-outline-warning w-100">
                                        üèÜ Ranking
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Go Back Button -->
                        <div class="mt-4">
                            <button onclick="goBack()" class="btn btn-outline-secondary">
                                ‚Üê Regresar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Technical Details (for developers) -->
                <div class="mt-3" th:if="${trace}">
                    <div class="card">
                        <div class="card-header">
                            <button class="btn btn-link text-decoration-none p-0"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#technicalDetails"
                                    aria-expanded="false"
                                    aria-controls="technicalDetails">
                                üîß Detalles T√©cnicos (Desarrolladores)
                            </button>
                        </div>
                        <div class="collapse" id="technicalDetails">
                            <div class="card-body">
                                <pre class="text-muted small" th:text="${trace}">Stack trace</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-retry Modal (Optional) -->
<div class="modal fade" id="retryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Reintentando...</span>
                </div>
                <p class="mb-0">Reintentando autom√°ticamente...</p>
                <small class="text-muted">Intento <span id="retryCount">1</span> de 3</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/game.js}"></script>
<script>
    // Go back function
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    }

    // Error animation
    window.addEventListener('load', function() {
        const errorIcon = document.querySelector('.error-animation');
        if (errorIcon) {
            // Shake animation
            errorIcon.style.animation = 'shake 0.5s ease-in-out';

            // Add shake animation to CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
    });

    // Auto-retry functionality (for network errors)
    let retryCount = 0;
    const maxRetries = 3;

    function autoRetry() {
        if (retryCount < maxRetries) {
            retryCount++;
            document.getElementById('retryCount').textContent = retryCount;

            const retryModal = new bootstrap.Modal(document.getElementById('retryModal'));
            retryModal.show();

            setTimeout(() => {
                retryModal.hide();
                window.location.reload();
            }, 3000);
        }
    }

    // Check if it's a network error and auto-retry
    const errorMessage = /*[[${error}]]*/ '';
    if (errorMessage.toLowerCase().includes('network') ||
        errorMessage.toLowerCase().includes('connection') ||
        errorMessage.toLowerCase().includes('timeout')) {

        setTimeout(autoRetry, 2000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case 'r':
            case 'R':
                if (e.ctrlKey || e.metaKey) return; // Don't interfere with browser refresh
                window.location.reload();
                break;
            case 'h':
            case 'H':
                window.location.href = '/';
                break;
            case 'g':
            case 'G':
                window.location.href = '/game/start';
                break;
            case 'Escape':
                goBack();
                break;
        }
    });

    // Service worker registration for offline support (optional)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(function(error) {
            console.log('Service Worker registration failed:', error);
        });
    }

    // Report error to analytics (if available)
    function reportError() {
        const errorData = {
            message: /*[[${error}]]*/ 'Unknown error',
            status: /*[[${status}]]*/ 500,
            url: window.location.href,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        };

        // Send to analytics service
        if (typeof gtag !== 'undefined') {
            gtag('event', 'exception', {
                description: errorData.message,
                fatal: false
            });
        }
    }

    // Auto-focus refresh button for accessibility
    window.addEventListener('load', function() {
        const refreshBtn = document.querySelector('.btn-warning');
        if (refreshBtn) {
            refreshBtn.focus();
        }
    });

    reportError();
</script>
</body>
</html>